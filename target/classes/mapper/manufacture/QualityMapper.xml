<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wyait.manage.dao.manufacture.QualityMapper">




    <select id="getDailyWorkPlan" resultType="com.wyait.manage.entity.manufacture.WorkPlanQualityDTO">
        SELECT pp.id as prodPlanID, pp.plandate, pp.invcode, i.cInvName as invName, i.cInvStd as invStd, p.procedurename, pp.planqty, isnull(w.qualifiedqty,0) + ISNULL(w.unqualifiedqty,0) AS realityQty, w.hasInspected
        FROM prodplan pp
        INNER JOIN Inventory i ON pp.invcode = i.cInvCode
        INNER JOIN proced p ON pp.procedurecode = p.procedurecode
        LEFT JOIN work w ON pp.id = w.prodPlanId
        WHERE pp.workstationcode = #{workStationCode} AND CONVERT(varchar,plandate,23) = CONVERT(varchar,GETDATE(),23)
    </select>

    <select id="getFirstInspectData" resultType="com.wyait.manage.entity.manufacture.FirstInspectVO">
        SELECT TOP(1) pp.id AS prodPlanId, pp.invcode, i.cInvName as invName, i.cInvStd as invStd, q.filepath, p.procedurename
        FROM prodplan pp
        INNER JOIN Inventory i ON pp.invcode = i.cInvCode
        INNER JOIN proced p ON pp.procedurecode = p.procedurecode
        LEFT JOIN qualityinstruction q ON pp.invcode = q.invcode AND pp.procedurecode = q.procedurecode
        WHERE pp.id = #{prodPlanId}
        ORDER BY q.version DESC
    </select>

    <insert id="firstInspect">
        INSERT INTO work (prodPlanId, hasInspected) VALUES (#{prodPlanId}, 1)
    </insert>
</mapper>